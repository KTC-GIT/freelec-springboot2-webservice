# 워크플로우의 이름
name: simple-springboot3-webservice

# 'main' 또는 'master' 브랜치에 'push' 또는 'pull_request'가 발생하면 실행
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# 실행할 작업
jobs:
  build:
    # GitHub가 제공하는 기본 Ubuntu 최신 환경에서 실행
    runs-on: ubuntu-latest

    steps:
      # (1) 소스 코드 가져오기
      - name: Checkout
        uses: actions/checkout@v4

      # (2) JDK 21 설치 (프로젝트에 맞게 8, 17 등으로 변경)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # [핵심] setup-gradle 액션 사용
      # 이 액션이 'gradle/wrapper/gradle-wrapper.properties' 파일을 읽어
      # 정확한 버전의 Gradle을 설치하고 실행 환경을 설정해 줍니다.
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      # [변경] './gradlew' 대신 'gradle' 명령어를 바로 사용
      # setup-gradle이 'gradle' 명령어를 실행할 수 있게 해줍니다.
      - name: Build with Gradle
        run: gradle clean build

      #(1) AWS 인증 (OIDC 방식)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::335360747780:role/github-actions-deploy
          aws-region: ${{env.AWS_REGION}}

      # (2) 배포할 파일 압축 (Jar + appspec.yml + scripts)
      # build/libs, appspec.yml, scripts 폴더를 포함시킵니다.
      - name: Make zip file
        run: zip -r ./practice-deploy.zip . -x "*.git*"

      # (3) S3 업로드
      - name: Upload to S3
        run: aws s3 cp ./practice-deploy.zip s3://${{env.S3_BUCKET_NAME}}/practice-deploy.zip

      # (4) CodeDeploy 배포 요청
      - name: Code Deploy
        run: >
          aws deploy create-deployment
          --application-name ${{env.CODE_DEPLOY_APP_NAME}}
          --deployment-config-name CodeDeployDefault.AllAtOnce
          --deployment-group-name ${{env.CODE_DEPLOY_GROUP_NAME}}
          --s3-location bucket=${{env.S3_BUCKET_NAME}}, bundleType=zip, key=practice-deploy.zip